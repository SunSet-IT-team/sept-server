generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CUSTOMER
  EXECUTOR
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  REJECTED
  COMPLETED
  CANCELLED
}

enum AccountStatus {
  UNVERIFIED
  VERIFIED
  DELETED
  BANNED
}

enum FileType {
  DOCUMENT
  PICTURE
  OTHER
  REPORT_FILE
  PROFILE_PHOTO
  REGISTRATION_CERTIFICATE
  LICENSE
}

enum WorkFormat {
  INDIVIDUAL
  LEGAL_ENTITY
  SOLE_PROPRIETOR
}

enum ChatType {
  GENERAL
  ORDER_CUSTOMER
  ORDER_ADMIN
}

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  password         String
  phone            String?
  firstName        String?
  lastName         String?
  role             Role
  status           AccountStatus    @default(UNVERIFIED)
  statusUpdatedAt  DateTime         @default(now())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  executorProfile  ExecutorProfile?
  customerProfile  CustomerProfile?
  adminProfile     AdminProfile?

  reviewsGiven     Review[]         @relation("ReviewAuthor")
  reviewsReceived  Review[]         @relation("ReviewTarget")
  emailVerification EmailVerification?
  auditLogs        AuditLog[]
  files            File[]
  messages         Message[]
  chatParticipants ChatParticipant[]
}

model AdminProfile {
  id           String @id @default(uuid())
  userId       String @unique
  recoveryCode String?

  user         User   @relation(fields: [userId], references: [id])
}

model CustomerProfile {
  id         String    @id @default(uuid())
  userId     String    @unique
  user       User      @relation(fields: [userId], references: [id])

  orders     Order[]
  addresses  Address[]
  favorites  Favorite[] @relation("CustomerFavorites")
}

model ExecutorProfile {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id])

  workFormat       WorkFormat
  experience       Int?
  about            String?

  companyName      String?
  description      String?
  city             String?
  rating           Float?   @default(0.0)
  completedOrders  Int      @default(0)

  orders           Order[]
  files            File[]
  favorites        Favorite[] @relation("ExecutorFavorites")
}

model Favorite {
  id          String   @id @default(uuid())
  customerId  String
  executorId  String
  createdAt   DateTime @default(now())

  customer    CustomerProfile @relation("CustomerFavorites", fields: [customerId], references: [id])
  executor    ExecutorProfile @relation("ExecutorFavorites", fields: [executorId], references: [id])

  @@unique([customerId, executorId])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  action      String
  targetType  String
  targetId    String
  timestamp   DateTime @default(now())
  meta        Json?

  user        User     @relation(fields: [userId], references: [id])
}

model File {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  executorId  String?
  executor    ExecutorProfile? @relation(fields: [executorId], references: [id])

  reportId    String?
  report      Report?  @relation(name: "ReportFiles", fields: [reportId], references: [id])

  messageId   String?
  message     Message? @relation(fields: [messageId], references: [id])

  url         String
  filename    String
  mimetype    String
  type        FileType
  size        Int?
  uploadedAt  DateTime @default(now())
}

model Order {
  id           String      @id @default(uuid())

  title        String      @default("")
  objectType   String
  comment      String?

  distanceToSeptic       Float
  septicDepth            Float
  septicVolume           Float
  septicConstructionType String

  paymentMethod String
  workDate      DateTime
  status        OrderStatus @default(PENDING)
  priority      Int         @default(100)
  price         Float?

  addressId     String?
  address       Address?    @relation(fields: [addressId], references: [id])

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  customerId    String
  executorId    String?

  customer      CustomerProfile @relation(fields: [customerId], references: [id])
  executor      ExecutorProfile? @relation(fields: [executorId], references: [id])

  serviceId     String?
  service       Service?   @relation(fields: [serviceId], references: [id])

  reports       Report[]
  reviews       Review[]
  chats         Chat[]
}

model Service {
  id       String   @id @default(uuid())
  name     String
  priority Int      @default(100)

  orders   Order[]
}

model Review {
  id         String   @id @default(uuid())
  text       String
  rating     Int
  createdAt  DateTime @default(now())

  authorId   String
  targetId   String
  orderId    String?

  author     User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  target     User     @relation("ReviewTarget", fields: [targetId], references: [id])
  order      Order?   @relation(fields: [orderId], references: [id])
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  user         CustomerProfile @relation(fields: [userId], references: [id])

  value        String
  city         String?
  postalCode   String?
  coordinates  String?

  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())

  orders       Order[]
}

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Report {
  id        String   @id @default(uuid())
  text      String?
  files     File[]   @relation("ReportFiles")
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  createdAt DateTime @default(now())
}

model Chat {
  id          String   @id @default(uuid())
  orderId     String?
  order       Order?   @relation(fields: [orderId], references: [id])
  type        ChatType @default(GENERAL)
  createdAt   DateTime @default(now())

  participants ChatParticipant[]
  messages     Message[]
}

model ChatParticipant {
  id        String   @id @default(uuid())
  chatId    String
  userId    String

  user      User     @relation(fields: [userId], references: [id])
  chat      Chat     @relation(fields: [chatId], references: [id])

  @@unique([chatId, userId])
}

model Message {
  id         String   @id @default(uuid())
  chatId     String
  senderId   String
  text       String?
  createdAt  DateTime @default(now())

  chat       Chat     @relation(fields: [chatId], references: [id])
  sender     User     @relation(fields: [senderId], references: [id])
  files      File[]
}
