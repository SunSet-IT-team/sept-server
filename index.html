<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <title>–ß–∞—Ç –ø–æ –∑–∞–∫–∞–∑—É</title>
        <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
            }
            #messages {
                border: 1px solid #ccc;
                height: 300px;
                overflow-y: scroll;
                padding: 10px;
                margin-bottom: 10px;
            }
            .message {
                margin-bottom: 8px;
            }
        </style>
    </head>
    <body>
        <h1>–ß–∞—Ç –ø–æ –∑–∞–∫–∞–∑—É</h1>

        <div>
            <label>JWT Token:</label>
            <input type="text" id="token" style="width: 500px" />
        </div>
        <div>
            <label>Order ID:</label>
            <input type="number" id="orderId" />
            <button onclick="joinChat()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
        </div>

        <div id="messages"></div>

        <input type="text" id="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

        <script>
            let socket;
            let orderId = null;

            function joinChat() {
                orderId = Number(document.getElementById('orderId').value);
                const token = document.getElementById('token').value;

                socket = io('http://localhost:4001', {
                    auth: {token},
                });

                socket.on('connect', () => {
                    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ:', socket.id);
                    socket.emit('chat:join', orderId);
                });

                // –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
                socket.on('chat:history', (messages) => {
                    document.getElementById('messages').innerHTML = '';
                    messages.forEach((msg) => renderMessage(msg));
                });

                // –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                socket.on('message:received', (msg) => {
                    renderMessage(msg);
                });

                socket.on('message:status', (status) => {
                    console.log('üì¨ –°—Ç–∞—Ç—É—Å:', status);
                });

                socket.on('disconnect', () => {
                    console.log('–û—Ç–∫–ª—é—á–µ–Ω–æ');
                });

                socket.on('error', (err) => {
                    console.error('–û—à–∏–±–∫–∞:', err);
                });
            }

            function sendMessage() {
                const text = document.getElementById('text').value;
                if (socket && orderId && text.trim()) {
                    socket.emit('message:send', {
                        orderId,
                        content: text,
                    });
                    document.getElementById('text').value = '';
                }
            }

            function renderMessage(msg) {
                const div = document.createElement('div');
                div.className = 'message';
                div.textContent = `[${msg.senderId}] ${msg.content}`;
                document.getElementById('messages').appendChild(div);
            }
        </script>
    </body>
</html>
